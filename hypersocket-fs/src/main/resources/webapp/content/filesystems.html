<div id="tabMounts">

	<div class="modal" id="addMountForm" tabindex="-1" role="dialog" dialog-for="tabMounts">
		<div class="modal-dialog modal-lg" >
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-hidden="true">&times;</button>
					<h4 class="modal-title"></h4>
				</div>
				<div class="modal-body">
						<div class="propertyItem form-group">
							<label class="col-md-3 control-label" localize="mount.name.label"></label>
							<div class="propertyValue col-md-9">
								<input type="text" class="form-control"
									placeholder="" id="resourceName" maxlength="" name="resourceName" value="">
								<div>
									<span class="help-block" localize="mount.name.info"></span>
								</div>
							</div>
						</div>
						<div class="propertyItem form-group">
							<label class="col-md-3 control-label" localize="mount.path.label"></label>
							<div class="propertyValue col-md-9">
								<input type="text" class="form-control"
									placeholder="" id="virtualPath" maxlength="" name="virtualPath" value="">
								<div>
									<span class="help-block" localize="mount.path.info"></span>
								</div>
							</div>
						</div>
						
						<div id="mountProperties"></div>
						<div id="tabFile" class="dialogTab">
						<div class="propertyItem form-group">
							<label class="col-md-3 control-label" localize="mount.scheme.label"></label>
							<div class="propertyValue col-md-9">
								<div id="schemeButton"></div>
								<div>
									<span class="help-block" localize="mount.scheme.info"></span>
								</div>
							</div>
						</div>
						<div class="propertyItem form-group remoteDiv">
							<label for="server" class="col-md-3 control-label" localize="mount.server.label"></label>
							<div class="propertyValue col-md-9">
								<input type="text" class="form-control"
									placeholder="" id="serverName" maxlength="" name="server" value="">
								<div>
									<span class="help-block" localize="mount.server.info"></span>
								</div>
							</div>
						</div>
						<div class="propertyItem form-group remoteDiv portDiv">
							<label class="col-md-3 control-label" localize="mount.port.label"></label>
							<div class="propertyValue col-md-9">
								<input type="text" class="form-control"
									placeholder="" id="port" maxlength="" name="port" value="">
								<div>
									<span class="help-block" localize="mount.port.info"></span>
								</div>
							</div>
						</div>
						<div class="propertyItem form-group">
							<label class="col-md-3 control-label" localize="mount.path.label"></label>
							<div class="propertyValue col-md-9">
								<div id="pathField"></div>
								<div>
									<span class="help-block" localize="mount.path.info"></span>
								</div>
							</div>
						</div>						
					</div>
					<div id="tabAuth" class="dialogTab">
					
						<div class="propertyItem form-group credsDiv">
							<label for="username" class="col-md-3 control-label" localize="mount.username.label"></label>
							<div class="propertyValue col-md-9">
								<div id="usernameField"></div>
								<div>
									<span class="help-block" localize="mount.username.info"></span>
								</div>
							</div>
						</div>	
						<div class="propertyItem form-group credsDiv">
							<label for="password" class="col-md-3 control-label" localize="mount.password.label"></label>
							<div class="propertyValue col-md-9">
								<div id="passwordField"></div>
								<div>
									<span class="help-block" localize="mount.password.info"></span>
								</div>
							</div>
						</div>	
					</div>
					<div id="tabOptions" class="dialogTab">
						<div class="propertyItem">
							<label for="readOnly" class="col-md-3 control-label" 
								localize="mount.readOnly.label"></label> 
							<div class="propertyValue col-md-9">
								<input type="checkbox"
									name="readOnly" id="readOnly" />
								<div>
									<span class="help-block" localize="mount.readOnly.info"></span>
								</div>
							</div>
						</div>
						<div class="propertyItem">
							<label for="showHidden" class="col-md-3 control-label" 
								localize="mount.showHidden.label"></label> 
							<div class="propertyValue col-md-9">
								<input type="checkbox"
								name="showHidden" id="showHidden"/>
								<div>
									<span class="help-block" localize="mount.showHidden.info"></span>
								</div>
							</div>
						</div>
						<div class="propertyItem">
							<label for="showFolders" class="col-md-3 control-label" 
								localize="mount.showFolders.label"></label> 
							<div class="propertyValue col-md-9">
								<input type="checkbox"
								name="showFolders" id="showFolders" />
								<div>
									<span class="help-block" localize="mount.showFolders.info"></span>
								</div>
							</div>
						</div>
					</div>
					<div id="tabLogo" class="dialogTab">
						<div class="propertyItem">
							<label for="logo" class="col-md-3 control-label" 
								localize="mount.logo.label"></label> 
							<div class="propertyValue col-md-9">
								<div id="logo"></div>
								<div>
									<span class="help-block" localize="mount.logo.info"></span>
								</div>
							</div>
						</div>
					</div>
					<div id="tabRoles" class="dialogTab">
					<input type="hidden" id="resourceId" name="resourceId" value="" />
				</div>
				</div>
				<div class="modal-footer"></div>
			</div>
		</div>
	</div>
</div>
<div class="row">
	<div id="virtualFileSystemTree" class="col-md-4 panel panel-body">
		<div id="treeview"></div>
	</div>
	<div id="virtualFileSystemInfo" class="col-md-8 panel panel-body">
		<div class="col-md-12">
			<h4>Virtual File System</h4>
			<p>Here you can mount external files and folders to create a Virtual File System for your users.</p>
			
			<p>Build up your file system by creating virtual folders <i class="fa fa-folder-open-o"></i> and then mount any number of external file 
			systems <i class="fa fa-hdd-o"></i> to it. The files from the root folder of the mount will be mounted
			directly in the virtual folder. For example mounting the local folder <em>/home/user</em> to the virtual path <em>/home</em> will see
			the file <em>/home/user/readme.txt</em> mapped to the virtual file system path <em>/home/readme.txt</em>.</p>
			
		</div>
		
		
<!-- 		<div class="col-md-4"> -->
<!-- 			<h4>Resource Name:</h4> -->
<!-- 			<h4>Virtual Path:</h4> -->
<!-- 			<h4>Last Reconciled:</h4> -->
<!-- 			<h4>Scheme:</h4> -->
<!-- 		</div> -->
<!-- 		<div class="col-md-8"> -->
<!-- 			<h4><span id="infResourceName">Downloads</span></h4> -->
<!-- 			<h4><span id="infVirtualPath">/downloads</span></h4> -->
<!-- 			<h4><span id="infLastReconcile">Tue, 3 May 2016 11:45</span></h4> -->
<!-- 			<h4><span id="infScheme">Local</span></h4> -->
<!-- 		</div> -->
	</div>
</div>
<script type="text/javascript">
	$(document).ready(function() {
	
		$('#treeview').on('rename_node.jstree', function(node, data){
			debugger;
		    var oldText = data.old;
		    var newText = data.text;
		    getJSON('fs/rename' + data.node.original.virtualPath + "?toUri=" + basePath + "/api/fs/rename" + data.node.original.parentPath + newText, null, function(data) {
				 if(!data.success) {
					 showError(data.message);
				 }
				 var ref = $('#treeview').jstree(true);
				 ref.refresh(); 
			  }, function() {
				  var ref = $('#treeview').jstree(true);
				  ref.refresh();
				 return true;
		      });
		});
		
		$('.jstree-leaf').on('dblclick', function(){
			$('#treeview').jstree("edit");
		});
		
		var tree = $('#treeview').jstree({
			  "core" : {
			    "animation" : 0,
			    "multiple" : true,
			    "check_callback" : function (operation, node, node_parent, node_position, more) {
	                switch (operation) {
	                    case "move_node":
	                        return false;
	                        break;
	                    case "copy_node":
	                        return false;
	                        break;
	                    case "create_node":
	                        return operation === 'create_node' ? true : false;
	                        break;
	                    case "rename_node":
	                    	return node_parent.id ==='#' ? false : true;
	                        
	                }
	            },
			    "themes" : { "stripes" : false },
			    'data' : {
			    	"url": basePath + '/api/fs/tree'
			    }
			    
			  }, "types" : {
			        "mount" : {
			          "icon" : "fa fa-2x fa-hdd-o"
			        },
			        "default" : {
				          "icon" : "fa fa-2x fa-folder-open-o"
				        }
			  }, 
			  "contextmenu": {
				  "items": function(node, callback) {
					  debugger;
					  if(node.original.type==='mount') {
						  callback([{
							label: getResource("text.edit"),
						     action: function() {
						    	$(document).data('virtualPath', node.original.virtualPath);
 								getJSON('mounts/mount/' + node.original.resourceId, null, function(data) {
 									resourcePage.showEdit(data.resource);
 								});
						     }
						  },{
					    	label: getResource("text.delete"),
						    action: function() {
						    	getJSON('mounts/mount/' + node.original.resourceId, null, function(data) {
						    		resourcePage.deleteResource(data.resource);
								});
					        }
						  }]);
					  } else if(node.original.fileType==='ROOT') { 
						  callback([{
							  label: getResource("mountFiles.text"),
							  action: function() {
								  $(document).data('virtualPath', '/');
								  resourcePage.showCreate(new function() {
									  var ref = $('#treeview').jstree(true);
									  ref.refresh();
								  });
							  }
						  },{
							  label: getResource("createFolder.text"),
							  action: function() {
								  getJSON('fs/createVirtualFolder' + node.original.virtualPath + 'untitled folder', null, function(data) {
									  var ref = $('#treeview').jstree(true);
									  ref.refresh();
								  });
							  }
						  }]);
					  } else {
						  callback([{
							  label: getResource("mountFiles.text"),
							  action: function() {
								  $(document).data('virtualPath', node.original.virtualPath);
								  resourcePage.showCreate(new function() {
									  var ref = $('#treeview').jstree(true);
									  ref.refresh();
								  });
							  }
						  },{
							  label: getResource("createFolder.text"),
							  action: function() {
								  getJSON('fs/createVirtualFolder' + node.original.virtualPath + 'untitled folder', null, function(data) {
									  var ref = $('#treeview').jstree(true);
									  ref.refresh();
								  });
							  }
						  },{
							  label: getResource("text.rename"),
							  action: function() {
								var ref = $('#treeview').jstree(true);
								sel = ref.get_selected();
								if(!sel.length) { return false; }
								sel = sel[0];
								ref.edit(sel);
							  }
						  },{
							  label: "Delete",
							  action: function() {
								
							  }
						  }]);
					  }
					  
				  }
			  },
			  "plugins" : [
			      "contextmenu", "crrm", "types"
			  ]
		});
		
		$('#tabMounts').localize();
		
		var usernameInput = $('#usernameField').textInput({
			id: 'username',
			url: 'realms/realm/userVariables/' + $(document).data('session').currentRealm.id,
			getUrlData: function(data) {
				return data.resources;
			}
		});
		
		var pathInput = $('#pathField').textInput({
			id: 'path',
			url: 'realms/realm/userVariables/' + $(document).data('session').currentRealm.id,
			getUrlData: function(data) {
				return data.resources;
			}
		});
		
		var passwordInput = $('#passwordField').textInput({
			id: 'password',
			inputType: 'password',
			url: 'realms/realm/userVariables/' + $(document).data('session').currentRealm.id,
			getUrlData: function(data) {
				data.resources.push('password');
				return data.resources;
			}
		});
		
		var schemeButton = $('#schemeButton').selectButton({
			id: 'scheme',
			url: 'mounts/schemes',
			nameAttr: 'scheme',
			valueAttr: 'scheme',
			nameIsResourceKey: true,
			resourceKeyTemplate: 'mount.{0}.label',
			name: 'file',
			value: 'file',
			getUrlData: function(data) {
				return data.resources;
			},
			changed: function(widget) {
				var scheme = widget.getSelectedObject();
				if(scheme.remote) {
					if(getResourceNoDefault(scheme.scheme + '.server.label')!=null) {
						$("label[for='server']").text(getResource(scheme.scheme + '.server.label'));
					} else {
						$("label[for='server']").text(getResource('mount.server.label'));
					}
					$('.remoteDiv').show();
					if(!scheme.showPort) {
						$('.portDiv').hide();
					}
				} else {
					$('.remoteDiv').hide();
					$('#serverName').val('');
					$('#port').val('');
				}
				if(scheme.supportsCredentials) {								
					if(getResourceNoDefault(scheme.scheme + '.username.label')!=null) {
						$("label[for='username']").text(getResource(scheme.scheme + '.username.label'));
					} else {
						$("label[for='username']").text(getResource('mount.username.label'));
					}
					if(getResourceNoDefault(scheme.scheme + '.username.info')!=null) {
						$("span[localize='mount.username.info']").text(getResource(scheme.scheme + '.username.info'));
					} else {
						$("span[localize='mount.username.info']").text(getResource('mount.username.info'));
					}
					if(getResourceNoDefault(scheme.scheme + '.password.label')!=null) {
						$("label[for='password']").text(getResource(scheme.scheme + '.password.label'));
					} else {
						$("label[for='password']").text(getResource('mount.password.label'));
					}
					if(getResourceNoDefault(scheme.scheme + '.password.info')!=null) {
						$("span[localize='mount.password.info']").text(getResource(scheme.scheme + '.password.info'));
					} else {
						$("span[localize='mount.password.info']").text(getResource('mount.password.info'));
					}
					$('.credsDiv').show();
				} else {
					$('.credsDiv').hide();
					$('#username').val('');
					$('#password').val('');
				}
				$('#mountProperties').propertyPage({
					url : 'mounts/template/' + (widget.getValue() ? widget.getValue() : 'file'),
					showButtons : false,
					useTemplates : true,
					canUpdate : currentMenu.canUpdate,
					additionalTabs : [ {
						id : "tabFile",
						name : getResource("mount.details.label")
					},
					{
						id : "tabAuth",
						name : getResource("mount.auth.label")
					},
					{
						id : "tabOptions",
						name : getResource("mount.options.label")
					},
					{
						id : "tabRoles",
						name : getResource("label.roles")
					},
					{
						id : "tabLogo",
						name : getResource("mount.logo.label")
					},]
				});
			}
		});
		
		var logo = $('#logo').logoInput({
			defaultTextCallback: function() {
				return $('#resourceName').val();
			},
			typeCallback: function() {
				// Matches that used by the client so the shape/colour will be the same
				return 'FILE';
			},
			url : basePath + '/api/files/file'
		});
		
		$('#resourceName').on('input', function(){
			logo.defaultTextChanged();
		});
		
		if(currentMenu.canCreate || currentMenu.canUpdate) {
			getJSON('roles/list', null, function(data) {
				$('#tabRoles').multipleSelect({
					values : data.resources,
					selectedIsObjectList : true,
					resourceKey : 'mount'
				});
			});
		}
	
		var refreshFunc = function() {
			var ref = $('#treeview').jstree(true);
			ref.refresh(); 
		};
		
		var resourcePage = $('#tabMounts').ajaxResourcePage(
				{
					id : "Mounts",
					tableUrl : "mounts/table",
					title: getResource("filesystems.label"),
					infoHtml: getResource('filesystems.infoHtml'),
					icon: 'fa-folder-open',
					resourceUrl : "mounts/mount",
					importUrl: 'mounts/import',
					exportUrl: 'mounts/export',
					logo: true,
					logoResourceTypeCallback: function(resource) {
						return 'FILE';
					},
					fields : [ {
						name : "name",
						sortable: true
					}, {
						name : "scheme",
						isResourceKey : true,
						sortable: true
					}, {
						name : "url"
					} ],
					resourceKey : "mount",
					canCreate: currentMenu.canCreate,
					canUpdate: currentMenu.canUpdate,
					canDelete: currentMenu.canDelete,
					additionalActions : [ { resourceKey: "openMount",
						iconClass: "fa-folder-open-o",
						enabled: true,
						action : function(resource) {
							window.open('viewfs' + resource.virtualPath,
									'_blank',
									'width=1024,height=800,toolbar=0,menubar=0,location=0,status=1,scrollbars=0,resizable=0,left=0,top=0');
						}}],
					validate : function() {

						if ($('#resourceName').val() == '') {
							showError("error.nameRequired");
							return false;
						}

						if ($('#serverName').val() != '') {
							if (!isValidHostname($('#serverName').val())) {
								showError("error.hostnameInvalid");
								return false;
							}
						}

						return true;
					},
					clearDialog : function(isCreate) {
						
						schemeButton.enable();
						schemeButton.setValue('file');
						
					    if(isCreate) {
					    	schemeButton.changed();
					    }
						$('#resourceId').val('');
						$('#resourceName').val('');
						$('#virtualPath').val('');
						$('#virtualPath').attr('disabled', false);
						
						if($(document).data('virtualPath')!=null) {
							$('#virtualPath').val($(document).data('virtualPath'));
							$(document).data('virtualPath', null);
							$('#virtualPath').attr('disabled', true);
							
						}
						$('#serverName').val('');
						$('#port').val('');
						
						pathInput.setValue('');
						usernameInput.setValue('');
						passwordInput.setValue('');
						logo.clear();
						
						$('#readOnly').prop('checked', false);
						$('#showHidden').prop('checked', false);
						$('#showFolders').prop('checked', true);
						
						$('#tabRoles').multipleSelect();
						
					},
					createResource : function() {
						resource = new Object();
						resource.id = $('#resourceId').val();
						resource.name = $('#resourceName').val();
						resource.virtualPath = $('#virtualPath').val();
						resource.scheme = schemeButton.getValue();
						resource.server = $('#serverName').val();
						resource.port = $('#port').val();
						resource.path = pathInput.getValue();
						resource.username = usernameInput.getValue();
						resource.password = passwordInput.getValue();
						resource.readOnly = $('#readOnly').prop('checked') ? true : false;
						resource.showHidden = $('#showHidden').prop('checked') ? true : false;
						resource.showFolders = $('#showFolders').prop('checked') ? true : false;
						resource.logo = logo.getValue();
						resource.roles = $('#tabRoles').multipleSelectValues();
						$('#mountProperties').saveProperties(true, function(items) {
							resource.properties = items;
						});
						return resource;
					},
					displayResource : function(resource) {
						
						$('#resourceId').val(resource.id);
						$('#resourceName').val(resource.name);
						$('#virtualPath').val(resource.virtualPath);
						schemeButton.setValue(resource.scheme);
						schemeButton.disable();
						
						$('#serverName').val(resource.server);
						$('#port').val(resource.port);
						pathInput.setValue(resource.path);
						usernameInput.setValue(resource.username);
						passwordInput.setValue(resource.password);
						
						if(resource.logo == '')
							logo.clear();
						else
							logo.setValue(resource.logo);
						if(resource.readOnly) {
							$('#readOnly').prop('checked', true);
						}
						if(resource.showHidden) {
							$('#showHidden').prop('checked', true);
						}
						if(resource.showFolders) {
							$('#showFolders').prop('checked', true);
						}
						$('#tabRoles').multipleSelect({
							selected : resource.roles,
							selectedIsObjectList : true,
							resourceKey : 'mount'
						});
						
						$('#mountProperties').propertyPage({
							url : 'mounts/properties/' + resource.id,
							showButtons : false,
							useTemplates : true,
							canUpdate : currentMenu.canUpdate,
							additionalTabs : [ {
								id : "tabFile",
								name : getResource("mount.details.label")
							},
							{
								id : "tabAuth",
								name : getResource("mount.auth.label")
							},
							{
								id : "tabOptions",
								name : getResource("mount.options.label")
							},
							{
								id : "tabRoles",
								name : getResource("label.roles")
							},
							{
								id : "tabLogo",
								name : getResource("mount.logo.label")
							},]
						});
					},
					resourceUpdated: refreshFunc,
					resourceCreated: refreshFunc,
					resourceDeleted:refreshFunc,
					complete : function() {
						loadComplete();
					}
				});
			});
</script>