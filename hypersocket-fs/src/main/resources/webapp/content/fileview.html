<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>File View</title>
<link rel="shortcut icon" href="${uiPath}${brandIcon}">
<link rel="icon" type="image/png" href="${uiPath}/images/shield_16x16.png">
<link href="${uiPath}/css/bootstrap.min.css" type="text/css" rel="stylesheet">
<link href="${uiPath}/css/font-awesome.min.css" type="text/css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="${uiPath}/css/bootstrap-editable.css" media="screen" />
<link rel="stylesheet" type="text/css" href="${uiPath}/css/bootstrap-table.min.css" media="screen" />
<link href="${uiPath}/css/viewfs.css" type="text/css" rel="stylesheet">

<script src="${uiPath}/js/jquery.min.js"></script>
<script src="${uiPath}/js/jquery-ui.min.js"></script>
<script src="${uiPath}/js/bootstrap.min.js"></script>
<script src="${uiPath}/js/bootbox.min.js"></script>
<script src="${uiPath}/js/jquery.bootpag.min.js"></script>
<script src="${uiPath}/js/spin-min.js"></script>
<script src="${uiPath}/js/jquery.hotkeys.js"></script>
<script src="${uiPath}/js/bootstrap-wysiwyg.js"></script>
<script src="${uiPath}/js/codemirror.js"></script>
<script src="${uiPath}/js/bootstrap-slider.min.js"></script>
<script src="${uiPath}/js/bootstrap-datepicker.js"></script>
<script src="${uiPath}/js/notify.min.js"></script>
<script src="${uiPath}/js/hypersocket-utils.js"></script>
<script src="${uiPath}/js/hypersocket-widgets.js"></script>
<script src="${uiPath}/js/bootstrap-table.min.js"></script>
<script src="${uiPath}/js/bootstrap-editable.min.js"></script>

<script type="text/javascript">
	var regex = new RegExp(
			/(.[^\:]+)(\:\/\/)(.[^\/]+)(.[^\/]+)(.*\/viewfs\/)(.*)/);

	var url = regex.exec(stripFragment(document.URL));
	var baseURL = url[1] + url[2] + url[3] + url[4];
	var basePath = url[4];
	var mountPath = url[6];
	if (!mountPath.endsWith('/')) {
		mountPath += '/';
	}
	var viewfsPath = basePath + url[5];
	var cwd = mountPath;

	$.fn.editable.defaults.mode = 'inline';


	function actionFormatter(value, row, index) {

		var additionalActions = $(document).data('actions');
		var actionHtml = '';
		
		if(additionalActions && additionalActions.length > 0) {
			actionHtml += '<div id="dropdown_' + index + '" class="btn-group"><a class="btn btn-success row-additional dropdown-toggle" data-toggle="dropdown" href="#"><i class="fa fa-gears"></i></a>';
			actionHtml += '<ul class="dropdown-menu dropdown-menu-right" role="menu">';
			$.each(additionalActions,
					function(x, act) {
						if (act.enabled) {
							actionHtml += '<li><a class="row-' + act.resourceKey + '" href="#"><span>' + getResource(act.resourceKey + ".label") + '</span>&nbsp;&nbsp;<i class="fa ' + act.iconClass + '"></i></a></li>';
	
							$(document).off('click',
								'#dropdown_' + index + ' .row-' + act.resourceKey);
	
							$(document).on(
								'click',
								'#dropdown_' + index + ' .row-' + act.resourceKey,
								function() {
									path = mountPath + row.label;
									act.action(path, row, function(resource) {
										
									});
								});
						}
			});
			actionHtml += '</ul></div>';
			
			$(document).on('show.bs.dropdown', '#Actions' + index, function () {
				var dropdown = $(this);
				var resource = row
				$.each(additionalActions, function(x, act) {
					if(act.enabled) {
						if(act.displayFunction && act.displayFunction != '') {
							var display = window[act.displayFunction].apply(null, [resource]);
							var el = $('.row-' + act.resourceKey, dropdown);   
							if(display) {
								el.show();
							} else {
								el.hide();
							}
						}
						if(act.enableFunction && act.enableFunction != '') {
							if(!window[act.enableFunction].apply(null, [resource])) {
								var el = $('.row-' + act.resourceKey, dropdown);    
								el.parent().addClass('disabled');
								el.attr('disabled', true);
							}
						} 
					}
					
				});
			});
		}
		
		actionHtml += '<a class="delete tableAction btn btn-danger"><i class="fa fa-trash fa-fw"></i></a>';
		actionHtml += '<a class="edit tableAction btn btn-primary"><i class="fa fa-edit fa-fw"></i></a>';

		if (row.type != "Folder") {
			actionHtml += '<a class="download tableAction btn btn-success"><i class="fa fa-download fa-fw"></i></a>';
		} else {
			actionHtml += '<a href="#"><i class="fa fa-fw" style="width: 15px;"></i></a>';
		}

		return actionHtml;
	}

	function nameFormatter(value, row, index) {

		var outputHtml = '';
		if (row.type != 'Folder') {

			var className = "fa-file-o";
			var canOpen = true;
			if (row.type == 'application/zip') {
				className = "fa-file-zip-o";
				canOpen = false;
			} else if (row.type == 'image/jpeg') {
				className = "fa-file-image-o";
			} else if (row.type == 'image/x-png') {
				className = "fa-file-image-o";
			} else if (row.type == 'application/pdf') {
				className = "fa-file-pdf-o";
			} else {
				canOpen = false;
			}

			if (canOpen) {
				outputHtml += '<a href="' + baseURL + '/api/fs/download/'
						+ mountPath + row.label + '?forceDownload=false">';
			}
			outputHtml += '<i class="fileIcon fa ' + className + '"></i>';

			if (canOpen) {
				outputHtml += '</a>';
			}

			outputHtml += '<span class="fileLabel" data-original="' + row.label + '">'
					+ row.label + '</span>';

		} else {
			outputHtml += '<a href="' + viewfsPath + mountPath + row.label + '/"><i class="fileIcon fa fa-folder-open"></i></a><span class="fileLabel" data-original="' + row.label + '">'
					+ row.label + '</span>';
		}

		return outputHtml;
	}

	window.actionEvents = {
		'click .download' : function(e, value, row, index) {
			window.location = baseURL + '/api/fs/download/' + mountPath
					+ row.label + '?forceDownload=true';
		},
		'click .edit' : function(e, value, row, index) {
			e.stopPropagation();
			$('tr[data-index="' + index + '"]').find('.fileLabel').editable(
					'toggle');
		},
		'click .delete' : function(e, value, row, index) {

			$('.notifyjs-confirm-base .no').trigger('click');
			var arr = new Array();
			arr.push(row);
			$(document).data('deleteRow', arr);
			$(e.target).closest('a').notify({
				title : getResource("text.confirmDelete").format(row.label),
				button : getResource("text.delete")
			}, {
				style : 'confirm',
				position : 'left middle',
				autoHide : false,
				clickToHide : false,
				showDuration : 100
			});
		}
	};
	


	function rebindEditable() {
		$('.fileLabel').editable(
				{
					type : 'text',
					title : 'Enter new filename',
					showbuttons : false,
					toggle : 'manual',
					validate : function(value) {
						if ($.trim(value) == '') {
							return getResource('text.filenameCannotBeEmpty');
						}
					},
					url : function(params) {
						
						var d = new $.Deferred;
						var original = $(this).data('original');
						$.post(
								basePath + '/api/fs/rename/' + mountPath
										+ original,
								"toUri=" + basePath + '/api/fs/rename/'
										+ mountPath + params.value,
								function(data) {
									
									if (data.success) {
										d.resolve();
									} else {
										d.reject(data.error);
									}
								}, "json").fail(function(e) {
							d.reject(e);
						});

						return d.promise();

					}
				});
	};
	$(document).ready(
					function() {

						
							 
							 loadResources(function() {

								 getJSON('menus/tableActions/fileActions', null, function(data) {
										
										var actions = new Array();
										
										if(data.resources.length > 0) {
											$.each(data.resources, function(idx, action) {
												var div = action.resourceKey + 'Div';
												$('#additionalActions').append('<div id="' + div + '"></div>');
												$('#' + div).load(uiPath + 'content/' + action.url + '.html');
												actions.push({
													resourceKey : action.resourceKey,
													iconClass : action.iconClass,
													action : function(resource, row, callback) {
														if($('#' + action.resourceKey).data('action')) {
															$('#' + action.resourceKey).data('action')(resource, row, callback);
														}
													},
													enabled : true,
													enableFunction: action.enableFunction,
													displayFunction: action.displayFunction
												});
											});
										 }
										
										 $(document).data('actions', actions);
										
										 $.notify.addStyle(
											'confirm',
											{
												html : "<div>"
														+ "<div class='clearfix'>"
														+ "<div class='title' data-notify-html='title'/>"
														+ "<div class='buttons'>"
														+ "<button class='btn btn-primary no'>Cancel</button>"
														+ "<button class='btn btn-danger yes' data-notify-text='button'></button>"
														+ "</div>" + "</div>"
														+ "</div>"
											});

									$(document).on('click',
											'.notifyjs-confirm-base .no', function() {
												$(this).trigger('notify-hide');
											});

									$(document).on('click',
													'.notifyjs-confirm-base .yes',
													function() {
														
														var row = $(document).data('deleteRow');
														
														$.each(row, function(idx, row) {
															getJSON('fs/delete/' + mountPath + row.label,
																	null,
																	function(data) {
																		if (data.success) {
																			showInformation(getResource('text.deleted').format(row.label));
																			$('#table').bootstrapTable('refresh');
																		} else {
																			showError(getResource('text.deleteFailed').format(row.label));
																		}
																	});
														});
														
														$(this).trigger('notify-hide');
													});

									var breadcrumbs = mountPath.split('/');
									if (breadcrumbs[breadcrumbs.length - 1] == '') {
										breadcrumbs.pop();
									}
									var currentPath = '';
									$.each(breadcrumbs, function(idx, obj) {
										if(obj=='#') {
											return;
										}
										currentPath += obj + '/';
										if (idx < breadcrumbs.length - 1) {
											$('#breadcrumbs').append(
													'<li><a href="' + viewfsPath + currentPath + '">'
															+ decodeURIComponent(obj) + '</a></li>');
										} else {
											$('#breadcrumbs').append(
													'<li class="active">' + decodeURIComponent(obj)
															+ '</li>');

										}

									});
									
									$('#listingButton').click(function(e) {
										$('#table').bootstrapTable('refresh');
										$('#tableWrapper').show();
										$('#uploadWrapper').hide();
										$('#uploadWrapper').empty();
										
									});
									
									$('#uploadFileButton').click(function(e) {

										$('#tableWrapper').hide();
										$('#uploadWrapper').empty();

										$('#uploadWrapper').multipleFileUpload({
											  showDownloadButton: false,
											  showRemoveLine: false,
											  showEmptyRow: true,
										      url: basePath + '/api/fs/upload/' + currentPath
										});

										$('#uploadWrapper').show();
										
									});

									$('#uploadWrapper').hide();
									
									$('#table').bootstrapTable({
										url : basePath + '/api/fs/search/' + mountPath,
										queryParams: function(params) {
 											params._ = new Date().getTime();
											return params;
										},
										pagination : true,
										page : 1,
										pageSize : 10,
										pageList : [ 10, 20, 50, 100 ],
										clickToSelect : false,
										search : true,
										showColumns : true,
										showRefresh : true,
										showToggle : true,
										sidePagination : 'server',
										onLoadSuccess : function(data) {
											rebindEditable();
										},
										onLoadError: function(status) {
											getJSON(basePath + '/api/fs/lastError', null, function(data) {
												showError(data.message);
											});
										}
									});
									
									$('.fixed-table-toolbar').find('.btn-group').first().prepend('<button id="multipleDelete" class="btn btn-default" type="button" name="multipleDelete" title="Delete"><i class="fa fa-trash"></i></button>');
									$('.fixed-table-toolbar').find('.btn-group').first().prepend('<button id="newFolderButton" class="btn btn-default" type="button" name="newFolder" title="New Folder"><i class="fa fa-folder-open"></i></button>');

									$('#multipleDelete').click(
											function(e) {
										
												var arr = $('#table').bootstrapTable('getSelections');
												if(arr.length > 0) {
													$(document).data('deleteRow', arr);
													$('#multipleDelete').notify({
														title : getResource("text.confirmMultipleDelete").format(arr.length),
														button : getResource("text.delete")
													}, {
														style : 'confirm',
														position : 'left middle',
														autoHide : false,
														clickToHide : false,
														showDuration : 100
													});
												}
									});
									
									$('#newFolderButton').click(
											function(e) {
												
												getJSON('fs/createFolder/'
														+ currentPath, null, function(data) {
													$('#table').bootstrapTable(
															'append', data.resource);
													rebindEditable();
													$('.fileLabel').last().editable(
															'toggle');
												});
									});
								});
						});
						
						
					});
</script>
</head>
<body>
	<div id="viewfs">
		<div id="header">
			<img src="${uiPath}${brandImage}"></img>
			<ul id="navMenu" class="navicons">
				<li class="navicon"><a href="#" id="uploadFileButton"><i class="fa fa-upload"></i></a></li>
				<li class="navicon"><a href="#" id="listingButton"><i class="fa fa-table"></i></a></li>
			</ul>
		</div>
		<div id="navigation">
			<ol id="breadcrumbs" class="breadcrumb">

			</ol>
		</div>
		<div id="viewfsContent">
			<div id="tableWrapper">
			<table id="table">
				<thead>
					<tr>
						<th data-field="state" data-checkbox="true"></th>
						<th data-field="label" data-formatter="nameFormatter">Name</th>
						<th data-field="type">Type</th>
						<th data-field="lastModified">Last Modified</th>
						<th data-field="size">Size</th>
						<th data-field="action" data-formatter="actionFormatter"
							data-events="actionEvents">Action</th>
					</tr>
				</thead>
			</table>
			</div>
			<div class="row">
				<div id="uploadWrapper" class="col-md-12"></div>
			</div>
			<div id="uploadWrapper"></div>
		</div>
	</div>
	<div id="additionalActions"></div>
</body>
</html>
