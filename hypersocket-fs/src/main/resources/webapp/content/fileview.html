<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>File View</title>
<link rel="shortcut icon" href="${uiPath}/images/favicon.ico">
<link rel="icon" type="image/png" href="${uiPath}/images/shield_16x16.png">
<link rel="stylesheet" type="text/css" href="${uiPath}/css/viewfs.css"
	media="screen" />
<link rel="stylesheet" type="text/css" href="${uiPath}/css/aciTree.css"
	media="screen" />
<link rel="stylesheet" type="text/css" href="${uiPath}/theme/hypersocket/jquery-ui.custom.min.css" media="screen"/>
<style>
.ui-menu {
	width: 150px;
}

#menu {
	position: absolute;
	display: none;
}
</style>
<script type="text/javascript" src="${uiPath}/js/jquery.js"></script>
<script type="text/javascript" src="${uiPath}/js/jquery-ui.js"></script>
<script type="text/javascript" src="${uiPath}/js/hypersocket-utils.js"></script>
<script type="text/javascript" src="${uiPath}/js/jquery.aciPlugin.min.js"></script>
<script type="text/javascript" src="${uiPath}/js/jquery.aciTree.min.js"></script>
<script type="text/javascript">
	$(document).ready(
			function() {

				loadResources(function() {
					var regex = new RegExp(
							/(.[^\:]+)(\:\/\/)(.[^\/]+)(.[^\/]+)(.*\/viewfs\/)(.*)/);
					
					var url = regex.exec(document.URL);
					var baseURL = url[1] + url[2] + url[3] + url[4];
					var basePath = url[4];
					var mountPath = url[6];
					
					$(document).data('editing', false);
					$('#uploadInfo').localizeTooltip();
					
					$.getJSON(basePath + '/api/fsList/' + mountPath, null, function(data) {
						$('#viewfsFiles').aciTree({
							rootData : data.folders,
							editable: true,
							fullRow: true,
							selectable: true,
							columnData : [ {
								props : 'type'
							}, {
								props : 'size'
							}, {
								props : 'lastModified'
							} ],
							animateRoot : false
						});
					
						var api = $('#viewfsFiles').aciTree('api');
					
					
						$('#viewfsFiles').on(
								'acitree',
								function(event, api, item, eventName, options) {
									log(eventName);
									switch(eventName) {
									case 'selected':
										updateMenuState();
									break;
									
									case 'beforelabel':
										
										if(!$(document).data('editing')) {
	
											$(document).data('editing', true);
											var itemData = api.itemData(item);
											$.ajax({
												type: "POST",
											    url:  basePath + '/api/fsRename/' + mountPath + "/" + api.getId(item),
											    dataType: 'json',
											    data: { toUri : basePath + '/api/fsRename/' + mountPath + "/" + itemData.parent + '/' + options.label },
											    success: function(data) {
											    	
											    	if(!data.success) {
											    		// Display error
											    		showError(false, getResource("viewfs.cannotRename").format(options.label));
											    		api.setLabel(item, { label: options.oldLabel });
											    	} else {
											    		// Display renamed info
											    		if($(document).data('createFolder')) {
											    			showInformation(false, getResource("viewfs.created").format(options.label));
											    		} else {
											    			showInformation(false, getResource("viewfs.renamed").format(options.oldLabel, options.label));
											    		}
											    	}
											    },
											    error: function() {
											    	// Display error
											    	showError(false, getResource("viewfs.cannotRename").format(options.label));
											    	api.setLabel(item, { label: options.oldLabel });
											    },
											    complete: function() {
											    	$(document).data('editing', false);
											    	$(document).data('createFolder', false);
											    }
											});
										}
	
										return true;
										
									// we hook beforeopen .. so beforeload,
	                                // feed the data and open the node
									case 'dblclick':
	                                    $('#download').trigger('click');
										return true;
	                                case 'beforeopen':
										// only if was not loaded yet
	                                    if (!api.wasLoad(item)) {
	                                        // get item ID
	                                        var id = api.getId(item);
	                                        // load child items (by ID?)
	                                        $.getJSON(basePath + '/api/fsList/' + mountPath + '/' + id, null, function(data) {
	                                        	// feed the data
	                                            api.loadFrom(item, {
	                                                success: function(item) {
	                                                    // we need to open it (once loaded)
	                                                    this.open(item);
	                                                },
	                                                itemData: data.folders
	                                            });
	                                        });
	                                        
	                                        // prevent default action (prevent load)
	                                        updateMenuState();
	                                        return false;
	
	                                    }
	
	                                    break;
									}	
							}); 			
						
	
						$("#menu").menu();
						$('#menu').localize();
						$('#progressbar').progressbar();
						
						
						$('#uploadDialog').dialog({
						      autoOpen: false,
						      height: "auto",
						      width: 700,
						      modal: true,
						      title: "Upload File",
						      buttons: [{
							    	text : getResource('text.upload'),
							        click : function() {
							        	if(!$('#file')[0].files[0]) {
						        			$('#dialogError').dialogError("error.selectFile");
						 					return;
						 				}
							        	$('#progressbar').show();
						        		var formData = new FormData();
						        		formData.append( 'file', $('#file')[0].files[0]);
						        		var selected = api.selected();
						        		var childPath = "/";
						        		var folderItem = null;
						        		if(selected.length > 0) {
						        			childPath += api.itemData(selected).id;
						        			folderItem = selected;
						        		}
						        	    $.ajax({type        :   'POST',
						        	    	    url         :   basePath + '/api/fsUpload/' + mountPath + childPath,
						        	    	    dataType    :   'json',
						        	    	    cache: false,
						        	    	    contentType: false,
						        	    	    processData: false,
						        	    	    data        :   formData,
						        	    	    success     :   function(data){
						        	    	    	if(data.success) {
						        	    	    		api.append(folderItem, {
			                                                itemData: data.resource,
			                                                success: function(item, options) {
			                                                	if(folderItem!=null && !api.isOpen(folderItem)) {
			                                                		api.open(folderItem);
			                                                	}
			                                                	$('#dialogError').dialogInformation(getResource("viewfs.uploadComplete"));
			                                                	setTimeout(function() {
			                                                		$('#uploadDialog').dialog('close');	
			                                                	}, 2000);
			                                                	
			                                                },
			                                                fail: function(item, options) {
			                                                	$('#dialogError').dialogError(getResource("viewfs.uploadFailed"));
			                                                }
			                                            });
						        	    	    		
						        	    	    	} else {
						        	    	    		$('#dialogError').dialogError(data.message);
						        	    	    	}
						        	    	    },
						        	    	    xhr: function()
						        	    	    {
						        	    	         var xhr = new window.XMLHttpRequest();
						        	    	         //Upload progress
						        	    	         xhr.upload.addEventListener("progress", function(evt){
						        	    	           if (evt.lengthComputable) {
						        	    	             var percentComplete = (evt.loaded / evt.total) * 100;
						        	    	             //Do something with upload progress
						        	    	             log("loaded=" + evt.loaded + " total=" + evt.total + " percent="+ percentComplete);
						        	    	             $('#progressbar').progressbar("option", "value", percentComplete);
						        	    	          }
						        	    	        }, false);
						        	    	        //Download progress
						        	    	        xhr.addEventListener("progress", function(evt){
						        	    	          if (evt.lengthComputable) {
						        	    	            var percentComplete = (evt.loaded / evt.total) * 100;
						        	    	            //Do something with download progress
						        	    	            log("loaded=" + evt.loaded + " total=" + evt.total + " percent="+ percentComplete);
						        	    	            $('#progressbar').progressbar("option", "value", percentComplete);
						        	    	          }
						        	    	        }, false);
						        	    	        return xhr;
						        	    	    }
						        	    });
							        }
						      }],
						      close: function() {
						    	  
						      }
						});		
						
	 					$("#viewfsFiles").on("contextmenu", function(event) {
	 						var callback = function() {
 								updateMenuState();
 								
 		 						$("#menu").position({
 		 							my : isIE() && isIE() <= 8 ? "right top" : "left-5 top-5",
 		 							of : event
 		 						});
 							
 		 						$("#menu").show();
	 						};
	 						
 							var clicked = $(document.elementFromPoint(event.pageX, event.pageY));
 							if(clicked.attr('id') == 'viewfsFiles') {
 								// Unselected
 								var selected = api.selected();
 								api.select(selected, { select: false,
 									success: callback, 
 									fail: callback
 								});
 							} else {
		 						var li = $(document.elementFromPoint(event.pageX, event.pageY)).closest("li");
		 						api.select(li, {select: true, 
		 							success: callback,
		 							fail: callback
		 						});
	 						}
	 						return false;
	 					});
	
	 					$(document).click(function(e) {	
	 						hideMenu();
	 					});
	 					
	 					$("#viewfsFiles").click(function(e) {
	 						var selected = api.selected();
	 						if(selected.length > 0) {
	 							var clicked = $(document.elementFromPoint(event.pageX, event.pageY));
	 							if(clicked.attr('id') == 'viewfsFiles') {
	 								// Unselected
	 								api.select(selected, { select: false,
	 									success: function() {
	 										updateMenuState();
	 									}});
	 							}
	 						}
	 					});
						
						$('#download').click(function(e) {
	 						e.preventDefault();
	 						var selected = api.selected();
	 						if(selected.length > 0) {
	 							var item = api.itemData(selected);
	 							if(!item.isFolder) {
	 								document.location.href = baseURL + '/api/fsDownload/' + mountPath + '/' + item.id + '?forceDownload=true';
	 							}
	 						}
	 					});
						
						$('#upload').click(
								function(e) {
									e.preventDefault();
									$('#progressbar').hide();
									$('#uploadDialog').dialog('open');
						});
	
	 					$('#edit').click(function(e) {
	 						e.preventDefault();
	 						e.stopPropagation();
	 						var selected = api.selected();
	 						if(selected.length > 0) {
	 							var item = api.itemData(selected);
	 							api.edit(selected, { edit: true, save: false});
	 							hideMenu();
	 						}
	 					});
						
						$('#delete').click(function(e) {
							e.preventDefault();
							var selected = api.selected();
							if(selected.length > 0) {
								var item = api.itemData(selected);
								confirmBox({ title: getResource(item.isFolder ? "text.deleteFolder" : "text.deleteFile"), 
									message: getResource("mount.delete.desc").format(item.label), 
									callback: function() {
									$.getJSON(basePath + '/api/fsDelete/' + mountPath + "/" + item.id, function(data) {
										if(data.success) {  
											api.remove(selected);
											showInformation(false, getResource("viewfs.deleted").format(item.label));
										} else {
											showError(false, getResource("viewfs.cannotDelete").format(item.label));
										}
									});
								}});
							}
						});
						
						$('#refresh').click(
							function(e) {
								e.preventDefault();
								api.unload(null, {
									success : function() {
										api.option('jsonUrl', basePath + '/api/fsList/'
												+ mountPath);
										clearError();
										api.ajaxLoad();
									}
								});
						});
						
						$('#openFolder').click(
								function(e) {
									e.preventDefault();
									api.open(api.selected(), { 
										success: function() {
											updateMenuState();
										}
									});
						});
						
						$('#createFolder').click(
								function(e) {
									e.preventDefault();
									var selected = api.selected();
									var parentPath = basePath + '/api/fsCreateFolder/' + mountPath;
									var relativePath = mountPath;
									var item = null;
									if(selected.length > 0) {
										// Create under selected node (if a folder)
										parentPath += '/' + api.itemData(selected).id;
										relativePath += '/' + api.itemData(selected).id;
										item = selected;
									} 
									
									$.getJSON(parentPath, function(data) {
										if(data.success) {  
											api.append(item, {
                                                itemData: data.resource.folders[0],
                                                success: function(item, options) {
                                                	$(document).data('createFolder', true);
                                                	api.select(options.items, { select: true});
                                                	api.edit(options.items, { edit: true, save: false});
                    	 							hideMenu();
                                                }
                                            });
										} else {
											showError(false, getResource("viewfs.cannotCreateIn").format(relativePath));
										}
									});
						});
					}).fail(function(jqxhr, textStatus, error) {
						if(jqxhr.status==401) {
							msgBox({ title: getResource("text.error"), message: "Logon required" });
						} else {
							msgBox({ title: getResource("text.error"), message: error });
						}
					});
				});
			});
	
function hideMenu() {
	$("#menu").hide();
	$("#menu").css("top", "");
	$("#menu").css("left", "");
}

function updateMenuState() {
	
	var api = $('#viewfsFiles').aciTree('api');
	var item = api.selected();
	
	if(item.length > 0) {
		var itemData = api.itemData();	
		
		$('.unselectedAction').addClass('ui-state-disabled');
		$('.selectedAction').removeClass('ui-state-disabled');
		
		if(api.isFolder(item) && api.isOpen(item)) {
			$('.openFolderAction').removeClass('ui-state-disabled');
			$('.closedFolderAction').addClass('ui-state-disabled');
			$('.folderAction').removeClass('ui-state-disabled');
			$('.fileAction').addClass('ui-state-disabled');
		} else if (api.isFolder(item)) {
			$('.openFolderAction').addClass('ui-state-disabled');
			$('.closedFolderAction').removeClass('ui-state-disabled');
			$('.folderAction').removeClass('ui-state-disabled');
			$('.fileAction').addClass('ui-state-disabled');
		} else {
			$('.fileAction').removeClass('ui-state-disabled');
			$('.folderAction').addClass('ui-state-disabled');
			$('.openFolderAction').addClass('ui-state-disabled');
			$('.closedFolderAction').addClass('ui-state-disabled');
		}
	} else {
		$('.fileAction').addClass('ui-state-disabled');
		$('.folderAction').addClass('ui-state-disabled');
		$('.openFolderAction').addClass('ui-state-disabled');
		$('.closedFolderAction').addClass('ui-state-disabled');
		$('.selectedAction').addClass('ui-state-disabled');
		$('.unselectedAction').removeClass('ui-state-disabled');
	}
}
</script>
</head>
<body>
	<div id="viewfs">
		<div id="header"><img src="${uiPath}/theme/hypersocket/images/logo-small.png"></img></div>
		<div id="viewfsContent">
			<div id="informationBar" class="ui-widget"></div>
			<div id="viewfsFiles"
				class="aciTree aciTreeNoBranches aciTreeFullRow"></div>
		</div>
	</div>
	<ul id="menu">
		<li class="underline"><a id="refresh" href="#"><span
				class="ui-icon ui-icon-refresh"></span><span localize="text.refresh"></span></a></li>

		<li class="ui-state-disabled fileAction"><a id="download" href="#"><span
				class="ui-icon ui-icon-arrowthickstop-1-s"></span><span localize="text.download"></span></a></li>
		<li class="underline folderAction unselectedAction"><a id="upload" href="#"><span
				class="ui-icon ui-icon-arrowthickstop-1-s"></span><span localize="text.upload"></span></a></li>

		<li class="ui-state-disabled selectedAction"><a id="edit" href="#"><span
				class="ui-icon ui-icon-wrench"></span><span localize="text.rename"></span></a></li>
		<li class="underline ui-state-disabled selectedAction"><a id="delete"
			href="#"><span class="ui-icon ui-icon-trash"></span><span localize="text.delete"></span></a></li>

		<li class="closedFolderAction"><a id="openFolder" href="#"><span
				class="ui-icon ui-icon-folder-open"></span><span localize="text.open"></span></a></li>
		<li class="openFolderAction unselectedAction"><a id="createFolder" href="#"><span class="ui-icon ui-icon-folder-collapsed"></span><span localize="text.createFolder"></span></a></li>
	</ul>
	<div id="uploadDialog">
		<div id="dialogError"></div>
		<form id="uploadForm" method="POST" class="form"
	        enctype="multipart/form-data">
	 		<p id="uploadDesc"></p>
	 		<div class="formInputField">
				<span id="uploadInfo" class="ui-icon ui-icon-info" title="viewfs.upload.info"></span> <label id="fileLabel" for="filedata"
					class="formLabel" localize="label.certFile"></label>
			<input id="file" name="file" type="file" class="formInput text ui-widget-content ui-corner-all"/>
			</div>
		</form>
		<div id="progressbar"></div>
	</div>
</body>
</html>
